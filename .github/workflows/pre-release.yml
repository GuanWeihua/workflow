name: Pre-release

# on:
#     push:
#         branches: 
#             - release/**

on: workflow_dispatch

jobs:
    CustomEnvironmentVariables:
        runs-on: windows-latest

        strategy:
            matrix:
                node-version: [14.x]

        outputs:
            projectName: ${{ steps.setProjectName.outputs.value }}
            currentBranch: ${{ steps.setCurrentBranch.outputs.value }}
            currentVersion: ${{ steps.setCurrentVersion.outputs.value }}
            
        steps:
            - name: Checkout.
              uses: actions/checkout@v2
              with:
                ref: ${{github.ref}}

            - id: setCurrentVersion
              run: |
                ref="${{github.ref}}"
                version="${ref//$'refs/heads/release/'/''}"
                echo "::set-output name=value::$version"
              shell: bash
            
            - id: setCurrentBranch
              run: echo "::set-output name=value::${{github.ref}}"
            
            - id: package
              uses: codex-team/action-nodejs-package-info@v1

            - id: setProjectName
              run: echo "::set-output name=value::${{steps.package.outputs.name}}"


    # OutputEnvironmentVariables:
    #     runs-on: windows-latest

    #     strategy:
    #         matrix:
    #             node-version: [14.x]

    #     needs: CustomEnvironmentVariables

    #     steps:
    #         - run: echo ${{needs.CustomEnvironmentVariables.outputs.projectName}}
    #         - run: echo ${{needs.CustomEnvironmentVariables.outputs.currentBranch}}
    #         - run: echo ${{needs.CustomEnvironmentVariables.outputs.currentVersion}}

    Build:
        runs-on: windows-latest

        strategy:
            matrix:
                node-version: [14.x]

        needs: CustomEnvironmentVariables

        steps:
            # - name: Checkout.
            #   uses: actions/checkout@v2
            #   with:
            #     ref: ${{needs.CustomEnvironmentVariables.outputs.currentBranch}}
            
            - name: Install dependencies.
              run: npm install
            
            - name: Build project.
              run: npm run build

            - name: Generate changelog.
              run: npm run changelog

            - name: Publish release.
              uses: softprops/action-gh-release@v1
              with:
                draft: ${{ true }}
                prerelease: ${{ true }}
                tag_name: "v${{needs.CustomEnvironmentVariables.outputs.currentVersion}}-beta"
                name: "${{needs.CustomEnvironmentVariables.outputs.projectName}} v${{needs.CustomEnvironmentVariables.outputs.currentVersion}}-beta"
                body_path: "${{github.workspace}}\\CHANGELOG.md"
                token: ${{github.token}}
                files: |
                  dist
                  index.html